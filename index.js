(function(){var e,s,n,i,t,r,a,o,u,d,c,l,m,g,p,f,b,S,h,y,N,v,w,q;q=require("tvdbwebservice"),a=require("express"),s=a(),o=require("fs"),p=require("path"),d=require("http"),u=require("handlebars"),s.set("port",process.env.PORT),s.set("tvdbApiKey",process.env.TVDB_API_KEY),q.setTvdbApiKey(s.get("tvdbApiKey")),m=require("./mongodbclient.js"),m.setDbConfig(process.env.DB_USER,process.env.DB_PASSWORD),i=require("cookie-parser"),s.use(i()),h=require("express-session"),e=require("connect-mongo")(h),u.registerHelper("raw-helper",function(e){return e.fn()}),s.use(h({secret:"67gvgchgch987jbcfgxdfmhye435jvgxzdzf",store:new e({url:"mongodb://"+process.env.DB_USER+":"+process.env.DB_PASSWORD+"@ds029640.mongolab.com:29640/tvserieswebappdatabase",ttl:6048e5}),cookie:{maxAge:6048e5}})),n=require("body-parser"),g=require("multer"),s.use(n.json()),s.use(n.urlencoded({extended:!0})),s.use(g()),c=o.readFileSync("public/index.html","utf8"),f=o.readFileSync("public/series.html","utf8"),v=o.readFileSync("public/account/signup.html","utf8"),y=o.readFileSync("public/account/signin.html","utf8"),t=o.readFileSync("public/account/dashboard.html","utf8"),l=u.compile(c),b=u.compile(f),w=u.compile(v),N=u.compile(y),r=u.compile(t),s.use(function(e,s,n){s.header("Access-Control-Allow-Origin","*"),s.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),n()}),s.get("/series/seriesName/:name",function(e,s){q.getSeriesByName(e.params.name,function(e){s.end(e)})}),s.get("/series/seriesId/:id/seriesPlusActorsPlusBanners",function(e,s){q.getSeriesPlusActorsPlusBannersById(e.params.id,function(e){s.end(e)})}),s.get("/series/seriesId/:id/seriesOnly",function(e,s){q.getSeriesOnlyById(e.params.id,function(e){s.end(e)})}),s.get("/series/seriesId/:id/actors",function(e,s){q.getActorsForSeriesWithId(e.params.id,function(e){s.end(e)})}),s.get("/series/seriesId/:id/banners/",function(e,s){q.getBannersForSeriesWithId(e.params.id,function(e){s.end(e)})}),s.get("/",function(e,s){var n,i;console.log("requesting series homepage"),l||(c=o.readFileSync("public/index.html","utf8"),l=u.compile(c)),i={firstName:"",lastName:"",username:"",email:"",signinStatus:!1,signinPage:"/signin",dashboardPage:"",status:"Sign in",toggle:""},e.session.username&&(i={firstName:e.session.firstName,lastName:e.session.lastName,username:e.session.username,email:e.session.email,signinStatus:!0,signinPage:"",dashboardPage:"/dashboard",status:e.session.username,toggle:"dropdown"}),n=l(i),console.log("account:",i),s.writeHead(200,{"Context-Type":"text/html"}),s.write(n),s.end()}),s.get("/series",function(e,s){var n,i,t;console.log("requesting series",e.query),f||(c=o.readFileSync("public/series.html","utf8")),i={firstName:"",lastName:"",username:"",email:"",signinStatus:!1,signinPage:"/signin",dashboardPage:"",status:"Sign in",toggle:"",name:e.query.name,id:e.query.id},e.session.username&&(i={firstName:e.session.firstName,lastName:e.session.lastName,username:e.session.username,email:e.session.email,signinStatus:!0,signinPage:"",dashboardPage:"/dashboard",status:e.session.username,toggle:"dropdown",name:e.query.name,id:e.query.id}),t=u.compile(f),n=t(i),s.writeHead(200,{"Context-Type":"text/html"}),s.write(n),s.end()}),s.post("/signup",function(e,s){e.session.firstName="",e.session.lastName="",e.session.username="",e.session.email="",e.session.signinStatus=!1,m.checkIfEmailAlreadyRegistered(e.body.email,function(n){console.log("found status",n),n.status?s.redirect("/account/signup.html"):m.addNewUser({firstName:e.body.firstName,lastName:e.body.lastName,username:e.body.username,email:e.body.email,password:e.body.password},function(n){e.session.firstName=n.data.firstName,e.session.lastName=n.data.lastName,e.session.username=n.data.username,e.session.email=n.data.email,e.session.signinStatus=!0,s.redirect("/")})})}),s.get("/signin-status",function(e,s){e.session["signin-status"]=e.session.username?!0:!1,s.end(JSON.stringify({firstName:e.session.firstName,email:e.session.email,username:e.session.username,signinStatus:e.session.signinStatus}))}),s.get("/signout",function(e,s){e.session.destroy(function(e){s.redirect("/")})}),s.get("/signin",function(e,s){var n,i;s.writeHead(200,{"Context-Type":"text/html"}),i={email:"",errorMessage:""},N||(y=o.readFileSync("public/signin.html","utf8"),N=u.compile(y)),n=N(i),s.write(n),s.end()}),s.post("/signin",function(e,s){m.authenticateUserCredentials(e.body.email,e.body.password,function(n){e.session.username=n.data.username,e.session.firstName=n.data.firstName,e.session.lastName=n.data.lastName,e.session.email=n.data.email,e.session.username=n.data.username,console.log("user",n),e.session.signinStatus=n.data.signinStatus,e.session.signinStatus?s.redirect("/"):(s.writeHead(200,{"Context-Type":"text/html"}),N||(y=o.readFileSync("public/account/signin.html","utf8"),N=u.compile(y)),n.data.errorMessage="Either the username or password you entered is wrong",n=N(n.data),s.write(n),s.end())})}),s.get("/dashboard",function(e,s){var n,i;return console.log("requesting dashboard"),e.session.signinStatus?(i={firstName:e.session.firstName,lastName:e.session.lastName,username:e.session.username,email:e.session.email,signinStatus:!0,signinPage:"",dashboardPage:"/dashboard",status:e.session.username,toggle:"dropdown"},s.writeHead(200,{"Context-Type":"text/html"}),r||(t=o.readFileSync("public/account/dashboard.html","utf8"),r=u.compile(t)),n=r(i),s.write(n),s.end()):s.redirect("/signin")}),s.get("/subscriptions",function(e,s){e.session.signinStatus?m.getSubscribedTvShows(e.session.username,function(e){console.log("result is ",e),console.log("sending server data to client"),s.end(JSON.stringify(e,null,4))}):s.redirect("/signin")}),s.get("/subscribe",function(e,s){var n,i,t,r;t=e.query.name,i=e.query.id,n=e.query.artworkUrl,console.log(t,i),e.session.signinStatus?(r={subscriber:e.session.username,id:i,name:t,artworkUrl:n},m.addSeriesToSubscribedTvShows(r,function(e){return console.log(e),s.end(JSON.stringify(e,null,4))})):s.redirect("/signin")}),s.get("/unsubscribe",function(e,s){var n;e.session.signinStatus?(n={subscriber:e.session.username,id:e.query.id},m.removeSeriesFromSubscribedTvShows(n,function(e){return console.log(e),s.end(""+e)})):s.redirect("/signin")}),console.log("Attempting to start server at "+s.get("port")),S=d.createServer(s).listen(s.get("port"),function(){var e,s,n;e=S.address(),console.log("Node app is running at ",e),"darwin"===process.platform&&(n="webapp.tvseries",s=p.resolve(process.env.HOME,".pow/"+n),o.writeFile(s,e.port,function(e){return function(e){var i;return e?console.error(e):(console.log("Hosted on: "+n+".dev"),i=function(){var i;try{o.unlinkSync(s),console.log("Unhosted from: "+n+".dev")}catch(t){if(i=t,e)return console.error(e)}},process.on("SIGINT",function(){i(),process.exit()}),process.on("exit",function(e){i()}))}}(this)))}),s.use(a["static"](__dirname+"/public"))}).call(this);