(function(){var e,s,n,i,t,r,a,o,u,l,m,c,d,g,p,f,b,h,S,y,N,v,w,x,P;x=require("tvdbwebservice"),a=require("express"),s=a(),o=require("fs"),p=require("path"),l=require("http"),u=require("handlebars"),P={"first-name":"","last-name":"",username:"",email:"","signin-status":!1,"sigin-page":"","dashboard-page":""},s.set("port",process.env.PORT),s.set("tvdbApiKey",process.env.TVDB_API_KEY),x.setTvdbApiKey(s.get("tvdbApiKey")),d=require("./mongodbclient.js"),d.setDbConfig(process.env.DB_USER,process.env.DB_PASSWORD),i=require("cookie-parser"),s.use(i()),S=require("express-session"),e=require("connect-mongo")(S),u.registerHelper("raw-helper",function(e){return e.fn()}),s.use(S({secret:"67gvgchgch987jbcfgxdfmhye435jvgxzdzf",store:new e({url:"mongodb://"+process.env.DB_USER+":"+process.env.DB_PASSWORD+"@ds029640.mongolab.com:29640/tvserieswebappdatabase",ttl:6048e5}),cookie:{maxAge:6048e5}})),n=require("body-parser"),g=require("multer"),s.use(n.json()),s.use(n.urlencoded({extended:!0})),s.use(g()),m=o.readFileSync("public/index.html","utf8"),f=o.readFileSync("public/series.html","utf8"),v=o.readFileSync("public/account/signup.html","utf8"),y=o.readFileSync("public/account/signin.html","utf8"),t=o.readFileSync("public/account/dashboard.html","utf8"),c=u.compile(m),b=u.compile(f),w=u.compile(v),N=u.compile(y),r=u.compile(t),s.get("/series/seriesName/:name",function(e,s){x.getSeriesByName(e.params.name,function(e){s.end(e)})}),s.get("/series/seriesId/:id/seriesPlusActorsPlusBanners",function(e,s){x.getSeriesPlusActorsPlusBannersById(e.params.id,function(e){s.end(e)})}),s.get("/series/seriesId/:id/seriesOnly",function(e,s){x.getSeriesOnlyById(e.params.id,function(e){s.end(e)})}),s.get("/series/seriesId/:id/actors",function(e,s){x.getActorsForSeriesWithId(e.params.id,function(e){s.end(e)})}),s.get("/series/seriesId/:id/banners/",function(e,s){x.getBannersForSeriesWithId(e.params.id,function(e){s.end(e)})}),s.get("/",function(e,s){var n;console.log("requesting series homepage"),c||(m=o.readFileSync("public/index.html","utf8"),c=u.compile(m)),P={firstName:"",lastName:"",username:"",email:"",signinStatus:!1,signinPage:"/signin",dashboardPage:"",status:"Sign in",toggle:""},e.session.username&&(P={firstName:e.session.firstName,lastName:e.session.lastName,username:e.session.username,email:e.session.email,signinStatus:!0,signinPage:"",dashboardPage:"/dashboard",status:e.session.username,toggle:"dropdown"}),n=c(P),console.log("account:",P),s.writeHead(200,{"Context-Type":"text/html"}),s.write(n),s.end()}),s.get("/series.html",function(e,s){var n,i;console.log("requesting series"),f||(m=o.readFileSync("public/series.html","utf8")),P={firstName:"",lastName:"",username:"",email:"",signinStatus:!1,signinPage:"/signin",dashboardPage:"",status:"Sign in",toggle:""},e.session.username&&(P={firstName:e.session.firstName,lastName:e.session.lastName,username:e.session.username,email:e.session.email,signinStatus:!0,signinPage:"",dashboardPage:"/dashboard",status:e.session.username,toggle:"dropdown"}),i=u.compile(f),n=i(P),s.writeHead(200,{"Context-Type":"text/html"}),s.write(n),s.end()}),s.post("/signup",function(e,s){console.log("signing up th user"),e.session.firstName="",e.session.lastName="",e.session.username="",e.session.email="",e.session.signinStatus=!1,d.checkIfAlreadyRegistered(e.body.email,function(n){n?s.redirect("/signup"):d.addNewUser({firstName:e.body.firstName,lastName:e.body.lastName,username:e.body.username,email:e.body.email,password:e.body.password},function(n){e.session.firstName=n.firstName,e.session.lastName=n.lastName,e.session.username=n.username,e.session.email=n.email,e.session.signinStatus=!0,s.redirect("/")})})}),s.get("/signup",function(e,s){}),s.get("/signin-status",function(e,s){e.session["signin-status"]=e.session.username?!0:!1,s.end(JSON.stringify({firstName:e.session.firstName,email:e.session.email,username:e.session.username,signinStatus:e.session.signinStatus}))}),s.get("/signout",function(e,s){e.session.destroy(function(e){s.redirect("/")})}),s.get("/signin",function(e,s){var n;console.log("signin get================================================="),s.writeHead(200,{"Context-Type":"text/html"}),P={email:"",errorMessage:""},N||(y=o.readFileSync("public/signin.html","utf8"),N=u.compile(y)),n=N(P),s.write(n),s.end()}),s.post("/signin",function(e,s){console.log("signin route+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"),d.authenticateUserCredentials(e.body.email,e.body.password,function(n){var i;e.session.username=n.username,e.session.firstName=n.firstName,e.session.lastName=n.lastName,e.session.email=n.email,e.session.username=n.username,console.log("user",n),e.session.signinStatus=n.signinStatus,e.session.signinStatus?s.redirect("/"):(s.writeHead(200,{"Context-Type":"text/html"}),N||(y=o.readFileSync("public/account/signin.html","utf8"),N=u.compile(y)),n.errorMessage="Either the username or password you entered is wrong",i=N(n),s.write(i),s.end())})}),s.get("/dashboard",function(e,s){var n;return console.log("requesting dashboard"),e.session.signinStatus?(P={firstName:e.session.firstName,lastName:e.session.lastName,username:e.session.username,email:e.session.email,signinStatus:!0,signinPage:"",dashboardPage:"/dashboard",status:e.session.username,toggle:"dropdown"},s.writeHead(200,{"Context-Type":"text/html"}),r||(t=o.readFileSync("public/account/dashboard.html","utf8"),r=u.compile(t)),n=r(P),s.write(n),s.end()):s.redirect("/signin")}),s.use(a["static"](__dirname+"/public")),console.log("Attempting to start server at "+s.get("port")),h=l.createServer(s).listen(s.get("port"),function(){var e,s,n;e=h.address(),console.log("Node app is running at ",e),"darwin"===process.platform&&(n="webapp.tvseries",s=p.resolve(process.env.HOME,".pow/"+n),o.writeFile(s,e.port,function(e){return function(e){var i;return e?console.error(e):(console.log("Hosted on: "+n+".dev"),i=function(){var i;try{o.unlinkSync(s),console.log("Unhosted from: "+n+".dev")}catch(t){if(i=t,e)return console.error(e)}},process.on("SIGINT",function(){i(),process.exit()}),process.on("exit",function(e){i()}))}}(this)))})}).call(this);